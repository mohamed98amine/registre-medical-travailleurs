<!DOCTYPE html>
<html>
<head>
    <title>Test Base de Données Direct</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        button { padding: 10px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Test Persistance MySQL - Demandes d'Affiliation</h1>
    
    <div class="step">
        <h3>Étape 1: Créer utilisateurs</h3>
        <button onclick="createUsers()">Créer Utilisateurs</button>
        <div id="step1"></div>
    </div>

    <div class="step">
        <h3>Étape 2: Login Employeur</h3>
        <button onclick="loginEmployeur()">Login Employeur</button>
        <div id="step2"></div>
    </div>

    <div class="step">
        <h3>Étape 3: Créer Demande</h3>
        <button onclick="createDemande()">Créer Demande</button>
        <div id="step3"></div>
    </div>

    <div class="step">
        <h3>Étape 4: Vérifier Demandes</h3>
        <button onclick="checkDemandes()">Vérifier Mes Demandes</button>
        <div id="step4"></div>
    </div>

    <script>
        const API = 'http://localhost:8080/api';
        let token = '';

        function showResult(stepId, content, isError = false) {
            const div = document.getElementById(stepId);
            div.className = isError ? 'error' : 'success';
            div.innerHTML = '<pre>' + JSON.stringify(content, null, 2) + '</pre>';
        }

        async function createUsers() {
            try {
                const response = await fetch(`${API}/demandes-affiliation/create-test-users`, {
                    method: 'POST'
                });
                const data = await response.json();
                showResult('step1', data);
            } catch (error) {
                showResult('step1', { error: error.message }, true);
            }
        }

        async function loginEmployeur() {
            try {
                const response = await fetch(`${API}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'employeur@test.com',
                        password: 'password123'
                    })
                });
                const data = await response.json();
                if (data.token) {
                    token = data.token;
                    showResult('step2', { message: 'Login réussi', user: data.user });
                } else {
                    showResult('step2', data, true);
                }
            } catch (error) {
                showResult('step2', { error: error.message }, true);
            }
        }

        async function createDemande() {
            if (!token) {
                showResult('step3', { error: 'Veuillez vous connecter d\'abord' }, true);
                return;
            }

            try {
                const demande = {
                    raisonSociale: 'ENTREPRISE TEST SARL',
                    numeroRccm: 'RCCM-2024-TEST-001',
                    secteurActivite: 'Informatique et Services',
                    effectif: 15,
                    adresse: '123 Avenue de la Paix, Ouagadougou, Burkina Faso',
                    representantLegal: 'JEAN DUPONT',
                    email: 'contact@entreprise-test.bf',
                    telephone: '+226 70 12 34 56',
                    contactDrh: 'MARIE MARTIN',
                    chiffreAffaireAnnuel: 50000000,
                    commentaires: 'Demande de test pour vérification persistance'
                };

                console.log('Envoi demande:', demande);

                const response = await fetch(`${API}/demandes-affiliation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(demande)
                });

                const data = await response.json();
                console.log('Réponse serveur:', data);
                
                if (response.ok) {
                    showResult('step3', data);
                } else {
                    showResult('step3', data, true);
                }
            } catch (error) {
                console.error('Erreur:', error);
                showResult('step3', { error: error.message }, true);
            }
        }

        async function checkDemandes() {
            if (!token) {
                showResult('step4', { error: 'Veuillez vous connecter d\'abord' }, true);
                return;
            }

            try {
                const response = await fetch(`${API}/demandes-affiliation/my`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (response.ok) {
                    showResult('step4', {
                        message: `${data.length} demande(s) trouvée(s)`,
                        demandes: data
                    });
                } else {
                    showResult('step4', data, true);
                }
            } catch (error) {
                showResult('step4', { error: error.message }, true);
            }
        }
    </script>
</body>
</html>