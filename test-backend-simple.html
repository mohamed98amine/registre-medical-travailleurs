<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Test Backend Simple</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            padding: 30px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: -30px -30px 40px -30px;
        }
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 25px; 
            margin: 20px 0; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            border: 1px solid #e5e7eb;
        }
        button { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 10px 5px;
        }
        button:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .result { 
            margin: 15px 0; 
            padding: 15px; 
            border-radius: 8px; 
            font-family: 'Fira Code', monospace; 
            font-size: 13px; 
            line-height: 1.5;
            white-space: pre-wrap;
            border-left: 4px solid;
        }
        .result.success { background: #ecfdf5; color: #166534; border-color: #10b981; }
        .result.error { background: #fef2f2; color: #991b1b; border-color: #ef4444; }
        .result.info { background: #eff6ff; color: #1e40af; border-color: #3b82f6; }
        input, select, textarea { 
            padding: 10px 15px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            font-size: 14px; 
            width: 100%;
            margin: 5px 0;
            box-sizing: border-box;
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-group { margin: 15px 0; }
        label { font-weight: 600; color: #374151; font-size: 14px; display: block; margin-bottom: 5px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        #results { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ Test Backend Simple</h1>
            <p>Diagnostic de l'erreur 500 sur les demandes d'affiliation</p>
        </div>

        <!-- Configuration -->
        <div class="card">
            <h2>âš™ï¸ Configuration</h2>
            <div class="form-group">
                <label>Backend URL:</label>
                <input type="text" id="backendUrl" value="http://localhost:8080/api" />
            </div>
            <div class="grid">
                <div class="form-group">
                    <label>Email:</label>
                    <input type="text" id="email" value="kr98@gmail.com" />
                </div>
                <div class="form-group">
                    <label>Mot de passe:</label>
                    <input type="password" id="password" value="password123" />
                </div>
            </div>
            <button class="btn-primary" onclick="testConnection()">ğŸ” Test Connexion</button>
        </div>

        <!-- Tests Backend -->
        <div class="card">
            <h2>ğŸ§ª Tests Backend</h2>
            <button class="btn-primary" onclick="testHealthCheck()">â¤ï¸ Health Check</button>
            <button class="btn-success" onclick="testLogin()">ğŸ” Test Login</button>
            <button class="btn-success" onclick="testCreateDemande()">ğŸ“ Test CrÃ©ation Demande</button>
            <button class="btn-danger" onclick="testDirecteurs()">ğŸ‘” Test Directeurs</button>
        </div>

        <!-- Test crÃ©ation simple -->
        <div class="card">
            <h2>ğŸ“ Test CrÃ©ation Simple</h2>
            <button class="btn-success" onclick="createSimpleDemande()">âœ¨ CrÃ©er Demande Simple</button>
        </div>

        <!-- RÃ©sultats -->
        <div class="card">
            <h2>ğŸ“‹ RÃ©sultats</h2>
            <div id="results"></div>
        </div>
    </div>

    <script>
        let token = '';
        const API_BASE = () => document.getElementById('backendUrl').value;

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        async function testConnection() {
            addResult('ğŸ”„ Test de connexion au backend...', 'info');
            
            try {
                const response = await fetch(`${API_BASE()}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: document.getElementById('email').value, 
                        password: document.getElementById('password').value 
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    token = data.token;
                    addResult('âœ… Connexion rÃ©ussie - Token obtenu', 'success');
                } else {
                    const errorText = await response.text();
                    addResult(`âŒ Erreur connexion: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ Erreur rÃ©seau: ${error.message}`, 'error');
            }
        }

        async function testHealthCheck() {
            addResult('ğŸ”„ Test health check...', 'info');
            
            try {
                const response = await fetch(`${API_BASE()}/health`);
                if (response.ok) {
                    addResult('âœ… Backend accessible', 'success');
                } else {
                    addResult(`âš ï¸ Backend rÃ©pond avec ${response.status}`, 'info');
                }
            } catch (error) {
                addResult(`âŒ Backend inaccessible: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            addResult('ğŸ”„ Test login dÃ©taillÃ©...', 'info');
            
            try {
                const response = await fetch(`${API_BASE()}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: document.getElementById('email').value, 
                        password: document.getElementById('password').value 
                    })
                });

                addResult(`ğŸ“¤ Status: ${response.status}`, 'info');
                addResult(`ğŸ“¤ Headers: ${JSON.stringify([...response.headers.entries()])}`, 'info');

                const responseText = await response.text();
                addResult(`ğŸ“¤ Response: ${responseText}`, 'info');

                if (response.ok) {
                    const data = JSON.parse(responseText);
                    token = data.token;
                    addResult('âœ… Login rÃ©ussi', 'success');
                } else {
                    addResult(`âŒ Login Ã©chouÃ©: ${response.status}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ Erreur: ${error.message}`, 'error');
            }
        }

        async function testCreateDemande() {
            if (!token) {
                addResult('âŒ Connectez-vous d\'abord', 'error');
                return;
            }

            const demandeData = {
                raisonSociale: "Test SARL",
                numeroRccm: "BF-TEST-2024-001",
                secteurActivite: "Test",
                effectif: 5,
                adresse: "Test Adresse",
                representantLegal: "Test Rep",
                email: "test@test.com",
                telephone: "+22612345678",
                contactDrh: "Test DRH"
            };

            addResult('ğŸ”„ Test crÃ©ation demande...', 'info');
            addResult(`ğŸ“¤ Data: ${JSON.stringify(demandeData)}`, 'info');

            try {
                const response = await fetch(`${API_BASE()}/demandes-affiliation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(demandeData)
                });

                addResult(`ğŸ“¤ Status: ${response.status}`, 'info');
                addResult(`ğŸ“¤ Headers: ${JSON.stringify([...response.headers.entries()])}`, 'info');

                const responseText = await response.text();
                addResult(`ğŸ“¤ Response: ${responseText}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    addResult('âœ… Demande crÃ©Ã©e avec succÃ¨s !', 'success');
                } else {
                    addResult(`âŒ Erreur crÃ©ation: ${response.status}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ Erreur rÃ©seau: ${error.message}`, 'error');
            }
        }

        async function testDirecteurs() {
            if (!token) {
                addResult('âŒ Connectez-vous d\'abord', 'error');
                return;
            }

            addResult('ğŸ”„ Test rÃ©cupÃ©ration directeurs...', 'info');

            try {
                // Test avec un endpoint simple
                const response = await fetch(`${API_BASE()}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                addResult(`ğŸ“¤ Status: ${response.status}`, 'info');
                const responseText = await response.text();
                addResult(`ğŸ“¤ Response: ${responseText}`, response.ok ? 'success' : 'error');

            } catch (error) {
                addResult(`âŒ Erreur: ${error.message}`, 'error');
            }
        }

        async function createSimpleDemande() {
            if (!token) {
                addResult('âŒ Connectez-vous d\'abord', 'error');
                return;
            }

            // DonnÃ©es minimales
            const simpleData = {
                raisonSociale: "Test Simple",
                numeroRccm: "BF-SIMPLE-001",
                secteurActivite: "Test",
                effectif: 1,
                adresse: "Adresse test",
                representantLegal: "Test",
                email: "test@test.com",
                telephone: "123456789",
                contactDrh: "Test DRH"
            };

            addResult('ğŸ”„ CrÃ©ation demande simple...', 'info');

            try {
                const response = await fetch(`${API_BASE()}/demandes-affiliation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(simpleData)
                });

                const responseText = await response.text();
                addResult(`Status: ${response.status}`, response.ok ? 'success' : 'error');
                addResult(`Response: ${responseText}`, response.ok ? 'success' : 'error');

            } catch (error) {
                addResult(`âŒ Erreur: ${error.message}`, 'error');
            }
        }

        // Auto-dÃ©marrage
        window.addEventListener('load', () => {
            addResult('ğŸš€ Interface de diagnostic initialisÃ©e', 'info');
            addResult('ğŸ’¡ 1. Testez la connexion', 'info');
            addResult('ğŸ’¡ 2. Testez la crÃ©ation de demande', 'info');
            addResult('ğŸ’¡ 3. VÃ©rifiez les logs du backend', 'info');
        });
    </script>
</body>
</html>
