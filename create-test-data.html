<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cr√©er des donn√©es de test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #2563eb;
        }
        .success {
            background: #10b981;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #ef4444;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .info {
            background: #3b82f6;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .log {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèóÔ∏è Cr√©er des Donn√©es de Test</h1>
        <p>Ce script va cr√©er des donn√©es de test pour l'interface Directeur R√©gional</p>
        
        <div class="info">
            <strong>üìã √âtapes :</strong><br>
            1. Cr√©er une demande d'affiliation<br>
            2. Cr√©er un contrat bas√© sur cette demande<br>
            3. V√©rifier que tout fonctionne
        </div>

        <button class="button" onclick="createTestData()">üöÄ Cr√©er les donn√©es de test</button>
        <button class="button" onclick="clearLog()">üßπ Effacer les logs</button>
        
        <div id="result"></div>
        <div id="log" class="log"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('result').innerHTML = '';
        }

        async function createTestData() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="info">‚è≥ Cr√©ation des donn√©es de test en cours...</div>';
            
            try {
                log('üîë R√©cup√©ration du token d\'authentification...');
                
                // D'abord, on doit se connecter avec le compte Directeur R√©gional
                const email = prompt('Entrez votre email de Directeur R√©gional:', 'directeur.final@ost.bf');
                const password = prompt('Entrez votre mot de passe:', 'password123');
                
                if (!email || !password) {
                    throw new Error('Email et mot de passe requis');
                }
                
                const loginResponse = await fetch('http://localhost:8080/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                if (!loginResponse.ok) {
                    throw new Error(`Erreur de connexion: ${loginResponse.status}`);
                }

                const loginData = await loginResponse.json();
                const token = loginData.token;
                log('‚úÖ Connexion r√©ussie !');

                // Cr√©er une demande d'affiliation
                log('üìù Cr√©ation d\'une demande d\'affiliation...');
                const demandeData = {
                    raisonSociale: 'SONABHY SA',
                    numeroRccm: 'BF-OUA-2018-B-12345',
                    secteurActivite: 'Distribution carburants',
                    effectif: 245,
                    adresse: 'Zone Industrielle, Ouagadougou',
                    representantLegal: 'M. OUEDRAOGO Jean',
                    email: 'contact@sonabhy.bf',
                    telephone: '+226 25 30 40 50',
                    contactDrh: 'Jean OUEDRAOGO',
                    chiffreAffaireAnnuel: 15000000000
                };

                const demandeResponse = await fetch('http://localhost:8080/api/demandes-affiliation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(demandeData)
                });

                if (!demandeResponse.ok) {
                    const errorText = await demandeResponse.text();
                    log(`‚ùå Erreur demande: ${demandeResponse.status} - ${errorText}`);
                    throw new Error(`Erreur cr√©ation demande: ${demandeResponse.status}`);
                }

                const demande = await demandeResponse.json();
                log(`‚úÖ Demande d'affiliation cr√©√©e avec ID: ${demande.id}`);

                // Valider la demande d'affiliation
                log('‚úÖ Validation de la demande d\'affiliation...');
                const validationResponse = await fetch(`http://localhost:8080/api/demandes-affiliation/${demande.id}/valider`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        commentaires: 'Demande valid√©e pour test'
                    })
                });

                if (!validationResponse.ok) {
                    const errorText = await validationResponse.text();
                    log(`‚ö†Ô∏è Erreur validation: ${validationResponse.status} - ${errorText}`);
                }

                // Cr√©er un contrat bas√© sur cette demande
                log('üìÑ Cr√©ation d\'un contrat...');
                const contratData = {
                    demandeId: demande.id,
                    typeContrat: 'INDUSTRIE_PETROLIERE',
                    dateSignature: '2025-01-15',
                    dateDebut: '2025-02-01',
                    dateFin: '2026-01-31',
                    zoneMedicale: 'Ouagadougou Nord',
                    region: 'Centre'
                };

                const contratResponse = await fetch('http://localhost:8080/api/contrats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(contratData)
                });

                if (!contratResponse.ok) {
                    const errorText = await contratResponse.text();
                    log(`‚ùå Erreur contrat: ${contratResponse.status} - ${errorText}`);
                    throw new Error(`Erreur cr√©ation contrat: ${contratResponse.status}`);
                }

                const contrat = await contratResponse.json();
                log(`‚úÖ Contrat cr√©√© avec num√©ro: ${contrat.numeroContrat}`);

                // Cr√©er une deuxi√®me entreprise pour avoir plus de donn√©es
                log('üìù Cr√©ation d\'une deuxi√®me demande d\'affiliation...');
                const demande2Data = {
                    raisonSociale: 'BURKINA CONSTRUCTION SARL',
                    numeroRccm: 'BF-OUA-2019-B-67890',
                    secteurActivite: 'BTP et construction',
                    effectif: 120,
                    adresse: 'Secteur 15, Ouagadougou',
                    representantLegal: 'Mme KONE Aminata',
                    email: 'contact@burkina-construction.bf',
                    telephone: '+226 25 35 45 55',
                    contactDrh: 'Aminata KONE',
                    chiffreAffaireAnnuel: 5000000000
                };

                const demande2Response = await fetch('http://localhost:8080/api/demandes-affiliation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(demande2Data)
                });

                if (demande2Response.ok) {
                    const demande2 = await demande2Response.json();
                    log(`‚úÖ Deuxi√®me demande cr√©√©e avec ID: ${demande2.id}`);

                    // Valider la deuxi√®me demande
                    await fetch(`http://localhost:8080/api/demandes-affiliation/${demande2.id}/valider`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            commentaires: 'Deuxi√®me demande valid√©e pour test'
                        })
                    });

                    // Cr√©er le deuxi√®me contrat
                    const contrat2Data = {
                        demandeId: demande2.id,
                        typeContrat: 'CONSTRUCTION',
                        dateSignature: '2025-01-20',
                        dateDebut: '2025-02-15',
                        dateFin: '2026-02-14',
                        zoneMedicale: 'Ouagadougou Sud',
                        region: 'Centre'
                    };

                    const contrat2Response = await fetch('http://localhost:8080/api/contrats', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(contrat2Data)
                    });

                    if (contrat2Response.ok) {
                        const contrat2 = await contrat2Response.json();
                        log(`‚úÖ Deuxi√®me contrat cr√©√© avec num√©ro: ${contrat2.numeroContrat}`);
                    }
                }

                log('üéâ Donn√©es de test cr√©√©es avec succ√®s !');
                resultDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ <strong>Donn√©es de test cr√©√©es avec succ√®s !</strong><br><br>
                        üìä <strong>Ce qui a √©t√© cr√©√© :</strong><br>
                        ‚Ä¢ 2 demandes d'affiliation valid√©es<br>
                        ‚Ä¢ 2 contrats actifs<br>
                        ‚Ä¢ Entreprises : SONABHY SA et BURKINA CONSTRUCTION SARL<br><br>
                        üöÄ <strong>Vous pouvez maintenant :</strong><br>
                        ‚Ä¢ Aller sur "Gestion des contrats" pour voir la liste<br>
                        ‚Ä¢ Aller sur "Entreprises affili√©es" pour voir les entreprises<br>
                        ‚Ä¢ Tester l'amendement des contrats<br>
                        ‚Ä¢ Voir les statistiques mises √† jour
                    </div>
                `;

            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`);
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå <strong>Erreur lors de la cr√©ation des donn√©es :</strong><br>
                        ${error.message}<br><br>
                        üí° <strong>V√©rifiez que :</strong><br>
                        ‚Ä¢ Le backend est d√©marr√© sur le port 8080<br>
                        ‚Ä¢ Vous √™tes connect√© avec un compte Directeur R√©gional<br>
                        ‚Ä¢ L'email dans le script correspond √† votre compte
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
